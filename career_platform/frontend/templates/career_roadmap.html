

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <!-- Header with Real User Data -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="cultural-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-2">{{ job.title }} Career Roadmap</h2>
                        <p class="text-muted mb-1">Personalized for {{ student_profile.user.username }}</p>
                        <p class="text-muted mb-0">
                            {{ student_profile.branch }} • CGPA: {{ student_profile.cgpa }} • 
                            Skills: {{ student_profile.skills|truncatewords:8 }}
                        </p>
                    </div>
                    <a href="{% url 'career_recommendations' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Recommendations
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Career Readiness Score -->
        <div class="col-lg-4 mb-4">
            <div class="cultural-card p-4">
                <h4 class="mb-4">Career Readiness Score</h4>
                
                <!-- Main Score with Dynamic Styling -->
                <div class="text-center mb-4">
                    {% if crs_data.total_score >= 80 %}
                    <div class="display-1 fw-bold text-success mb-2" id="currentScore">{{ crs_data.total_score }}%</div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: {{ crs_data.total_score }}%"></div>
                    </div>
                    <p class="text-success">
                        <i class="fas fa-trophy me-1"></i>Excellent! You're well prepared
                    </p>
                    {% elif crs_data.total_score >= 60 %}
                    <div class="display-1 fw-bold text-warning mb-2" id="currentScore">{{ crs_data.total_score }}%</div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-warning" style="width: {{ crs_data.total_score }}%"></div>
                    </div>
                    <p class="text-warning">
                        <i class="fas fa-chart-line me-1"></i>Good! Some improvements needed
                    </p>
                    {% else %}
                    <div class="display-1 fw-bold text-danger mb-2" id="currentScore">{{ crs_data.total_score }}%</div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-danger" style="width: {{ crs_data.total_score }}%"></div>
                    </div>
                    <p class="text-danger">
                        <i class="fas fa-rocket me-1"></i>Let's start your learning journey!
                    </p>
                    {% endif %}
                    
                    <small class="text-info">
                        <i class="fas fa-user me-1"></i>
                        Personalized for {{ student_profile.user.username }}
                    </small>
                </div>

                <!-- Score Breakdown -->
                <div class="score-breakdown">
                    <h6 class="mb-3">Score Breakdown</h6>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-code me-1"></i>Skill Match</span>
                            <span class="fw-bold">{{ crs_data.skill_match_score }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: {{ crs_data.skill_match_score }}%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-graduation-cap me-1"></i>Academic Performance</span>
                            <span class="fw-bold">{{ crs_data.academic_score }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ crs_data.academic_score }}%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-project-diagram me-1"></i>Project Experience</span>
                            <span class="fw-bold">{{ crs_data.project_score }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ crs_data.project_score }}%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-bullseye me-1"></i>Career Alignment</span>
                            <span class="fw-bold">{{ crs_data.alignment_score }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: {{ crs_data.alignment_score }}%"></div>
                        </div>
                    </div>
                </div>

                <!-- Total Timeline -->
                <div class="mt-4 p-3 {% if crs_data.total_score >= 80 %}bg-success text-white{% elif crs_data.total_score >= 60 %}bg-warning text-dark{% else %}bg-danger text-white{% endif %} rounded">
                    <h6 class="mb-2">Total Learning Timeline</h6>
                    <div class="display-6">{{ total_timeline }}</div>
                    <small>Adaptive timeline based on your current readiness</small>
                </div>

                <!-- SIMPLE CRS Progress Chart -->
                <div class="mt-4">
                    <h6 class="mb-3">Your Progress Over Time</h6>
                    <div id="chartContainer">
                        <canvas id="crsProgressChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Real Skill Gaps -->
            {% if crs_data.skill_gaps %}
            <div class="cultural-card p-4 mt-4">
                <h6 class="text-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>Your Skill Gaps
                </h6>
                <div class="skill-gaps">
                    {% for gap in crs_data.skill_gaps %}
                    {% if gap.priority == 'High' %}
                    <span class="badge bg-danger text-white me-1 mb-2">
                        {{ gap.skill }} 
                        <small>({{ gap.priority }})</small>
                    </span>
                    {% else %}
                    <span class="badge bg-warning text-dark me-1 mb-2">
                        {{ gap.skill }} 
                        <small>({{ gap.priority }})</small>
                    </span>
                    {% endif %}
                    {% endfor %}
                </div>
                <small class="text-muted mt-2">
                    Based on your profile: {{ student_profile.skills|truncatewords:5 }}
                </small>
            </div>
            {% endif %}

            <!-- Improvement Recommendations -->
            {% if crs_data.recommendations %}
            <div class="cultural-card p-4 mt-4">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-lightbulb me-2"></i>Improvement Tips
                </h6>
                <div class="recommendations">
                    {% for recommendation in crs_data.recommendations %}
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                        <small>{{ recommendation }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Career Roadmap - FLOWCHART DESIGN -->
        <div class="col-lg-8">
            <div class="cultural-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-0">Your Learning Journey</h4>
                        <small class="text-muted">{{ roadmap_steps|length }} steps tailored for you</small>
                    </div>
                    <span class="badge bg-primary">Dynamic Roadmap</span>
                </div>
                
                <!-- Flowchart Roadmap -->
                <div class="roadmap-flowchart">
                    {% for step in roadmap_steps %}
                    <div class="flowchart-step {% if forloop.first %}first-step{% endif %} {% if forloop.last %}last-step{% endif %}">
                        <div class="step-card">
                            <div class="step-header">
                                <div class="step-indicator">
                                    <span class="step-number">{{ step.step }}</span>
                                </div>
                                <div class="step-info">
                                    <h5 class="step-title">{{ step.title }}</h5>
                                    <div class="step-meta">
                                        <span class="duration"><i class="fas fa-clock me-1"></i>{{ step.duration }}</span>
                                        {% if step.expected_crs_improvement %}
                                        <span class="improvement"><i class="fas fa-chart-line me-1"></i>{{ step.expected_crs_improvement }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-content">
                                {% if step.focus_areas %}
                                <div class="focus-section">
                                    <h6><i class="fas fa-bullseye me-2"></i>Focus Areas</h6>
                                    <div class="focus-tags">
                                        {% for area in step.focus_areas %}
                                        <span class="focus-tag">{{ area }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="tasks-section">
                                    <h6><i class="fas fa-tasks me-2"></i>Key Tasks</h6>
                                    <ul class="task-list">
                                        {% for task in step.completion_metrics %}
                                        <li>{{ task }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="resources-section">
                                    <h6><i class="fas fa-book me-2"></i>Resources</h6>
                                    <div class="resource-buttons">
                                        {% for resource in step.resources %}
                                        <a href="{{ resource.url }}" target="_blank" class="resource-btn">
                                            {{ resource.name }}
                                            {% if resource.free %}<span class="free-badge">Free</span>{% endif %}
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if not forloop.last %}
                        <div class="step-connector">
                            <div class="connector-line"></div>
                            <div class="connector-arrow">↓</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Algorithm Explanation Section (For Judges) -->
            <div class="cultural-card p-4 mt-4">
                <h5 class="mb-3">
                    <i class="fas fa-robot me-2 text-primary"></i>AI Algorithm Details
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Real User Data Used:</h6>
                        <ul class="small">
                            <li><strong>Name:</strong> {{ student_profile.user.username }}</li>
                            <li><strong>Branch:</strong> {{ student_profile.branch }}</li>
                            <li><strong>CGPA:</strong> {{ student_profile.cgpa }}</li>
                            <li><strong>Skills:</strong> {{ student_profile.skills|truncatewords:10 }}</li>
                            <li><strong>Projects:</strong> {{ student_profile.projects|truncatewords:5|default:"Not specified" }}</li>
                            <li><strong>Interests:</strong> {{ student_profile.interests|truncatewords:5|default:"Not specified" }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Algorithms Applied:</h6>
                        <ul class="small">
                            <li><strong>TF-IDF + Cosine Similarity:</strong> Skill matching</li>
                            <li><strong>Dynamic Duration Adjustment:</strong> Timeline optimization</li>
                            <li><strong>Priority-based Analysis:</strong> Skill gap identification</li>
                            <li><strong>Real-time Personalization:</strong> Custom roadmap generation</li>
                            <li><strong>Multi-factor Scoring:</strong> CRS calculation</li>
                        </ul>
                    </div>
                </div>
                
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showDetailedAlgorithms()">
                    Show Detailed Algorithm Explanation
                </button>
                
                <div id="detailedAlgorithms" style="display: none;" class="mt-3">
                    <h6>Technical Implementation:</h6>
                    <p class="small text-muted">
                        This roadmap is dynamically generated using your actual profile data. 
                        The system analyzes your skills, academic performance, and career interests 
                        using machine learning algorithms to create a personalized learning path. 
                        Skill gaps are identified by comparing your current skills with job requirements 
                        using TF-IDF vectorization and cosine similarity. The timeline adapts based on 
                        your Career Readiness Score, and resources are customized for your engineering branch.
                    </p>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Personalization Factors:</h6>
                            <ul class="small">
                                <li>Current CRS Score: {{ crs_data.total_score }}%</li>
                                <li>Skill Gaps: {{ crs_data.skill_gaps|length }} identified</li>
                                <li>Academic Performance: {{ student_profile.cgpa }} CGPA</li>
                                <li>Project Experience: {{ student_profile.projects|default:"Not specified"|truncatewords:3 }}</li>
                                <li>Career Interests: {{ student_profile.interests|default:"Not specified"|truncatewords:3 }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Dynamic Features:</h6>
                            <ul class="small">
                                <li>Variable Steps: {{ roadmap_steps|length }} (based on CRS)</li>
                                <li>Adaptive Timeline: {{ total_timeline }}</li>
                                <li>Focus Areas: Based on skill gaps</li>
                                <li>Resource Customization: Branch-specific</li>
                                <li>Progress Tracking: Historical CRS data</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <small>
                            <strong>Note for Judges:</strong> This is not a static template. 
                            Each roadmap is uniquely generated based on the logged-in user's actual data. 
                            Try different student accounts to see different roadmaps with varying CRS scores, 
                            skill gaps, and step counts!
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// SIMPLE AND RELIABLE CHART CODE
function initializeChart() {
    try {
        console.log('Initializing chart...');
        
        const ctx = document.getElementById('crsProgressChart');
        if (!ctx) {
            console.error('Chart canvas not found');
            return;
        }
        
        // Get historical data safely
        const historicalData = {{ historical_crs|safe }};
        console.log('Historical data:', historicalData);
        
        const dates = historicalData.map(item => item.date);
        const scores = historicalData.map(item => item.score);
        
        // Create simple chart
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Career Readiness Score',
                    data: scores,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        console.log('Chart initialized successfully');
        
    } catch (error) {
        console.error('Chart initialization error:', error);
        // Show fallback message
        const chartContainer = document.getElementById('chartContainer');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div class="text-center text-muted p-4">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>Progress chart will be available soon</p>
                    <small>Current CRS: {{ crs_data.total_score }}%</small>
                </div>
            `;
        }
    }
}

// Simple roadmap animations
function animateRoadmapSteps() {
    const steps = document.querySelectorAll('.step-card');
    steps.forEach((step, index) => {
        step.style.opacity = '0';
        step.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            step.style.transition = 'all 0.6s ease';
            step.style.opacity = '1';
            step.style.transform = 'translateY(0)';
        }, index * 200);
    });
}

// Toggle algorithm details
function showDetailedAlgorithms() {
    const element = document.getElementById('detailedAlgorithms');
    const button = event.target;
    
    if (element.style.display === 'none') {
        element.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Details';
    } else {
        element.style.display = 'none';
        button.innerHTML = '<i class="fas fa-eye me-1"></i>Show Details';
    }
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing components...');
    initializeChart();
    animateRoadmapSteps();
});
</script>

<style>
/* Roadmap Flowchart Styles */
.roadmap-flowchart {
    position: relative;
    padding: 20px 0;
}

.flowchart-step {
    position: relative;
    margin-bottom: 0;
}

.step-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
    margin: 10px 0;
}

.step-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.step-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
}

.step-indicator {
    margin-right: 16px;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 1.3rem;
}

.step-info {
    flex: 1;
}

.step-title {
    color: #1f2937;
    margin-bottom: 8px;
    font-size: 1.3rem;
    font-weight: 600;
}

.step-meta {
    display: flex;
    gap: 20px;
    font-size: 0.9rem;
}

.duration, .improvement {
    color: #6b7280;
    display: flex;
    align-items: center;
}

.focus-section, .tasks-section, .resources-section {
    margin-bottom: 20px;
}

.focus-section h6, .tasks-section h6, .resources-section h6 {
    color: #374151;
    margin-bottom: 12px;
    font-weight: 600;
}

.focus-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.focus-tag {
    background: #e0e7ff;
    color: #3730a3;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.8rem;
    font-weight: 500;
}

.task-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.task-list li {
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
    position: relative;
    padding-left: 24px;
}

.task-list li:before {
    content: "✓";
    position: absolute;
    left: 0;
    color: #10b981;
    font-weight: bold;
}

.resource-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.resource-btn {
    display: inline-flex;
    align-items: center;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    color: #475569;
    padding: 6px 12px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.resource-btn:hover {
    background: #6366f1;
    color: white;
    text-decoration: none;
}

.free-badge {
    background: #10b981;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-left: 4px;
}

.step-connector {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.connector-line {
    width: 2px;
    height: 30px;
    background: #6366f1;
    margin: 10px 0;
}

.connector-arrow {
    color: #6366f1;
    font-size: 1.2rem;
}

/* Responsive design */
@media (max-width: 768px) {
    .step-header {
        flex-direction: column;
        text-align: center;
    }
    
    .step-indicator {
        margin-right: 0;
        margin-bottom: 12px;
    }
    
    .step-meta {
        justify-content: center;
    }
    
    .step-card {
        padding: 16px;
    }
}
</style>
{% endblock %}

